# MySQL Database Support

The WebApp package provides comprehensive MySQL database support with a powerful query builder, migration system, and table management tools.

## Features

- **Type-safe Query Builder**: Fluent API for building SQL queries
- **Database Migrations**: Automated schema management and version control
- **Table Management**: Programmatic table creation and modification
- **Connection Management**: Efficient connection pooling
- **Advanced SQL Support**: Joins, subqueries, aggregations, and complex conditions

## Installation

Add the MySQL dependencies to your `pubspec.yaml`:

```yaml
dependencies:
  webapp: ^1.0.0
  mysql_client: ^0.0.27
  sqler: ^1.1.2
```

## Quick Start

### Import the MySQL Library

```dart
import 'package:webapp/wa_mysql.dart';
import 'package:mysql_client/mysql_client.dart';
```

### Basic Query Examples

```dart
// Simple SELECT query
var query = Q()
  .selects([QSelectAll()])
  .from(QField('users'))
  .where(WhereOne(QField('email'), QO.EQ, QVar('user@example.com')));

String sql = query.toSQL();
// Output: SELECT * FROM `users` WHERE ( `email` = 'user@example.com' )
```

### Complex Query with Joins

```dart
var query = Q()
  .selects([
    QSelect('users.id'),
    QSelect('users.name'),
    QSelect('profiles.avatar', as: 'profile_image')
  ])
  .from(QField('users'))
  .join(LeftJoin('profiles', On([
    Condition(QField('users.id'), QO.EQ, QField('profiles.user_id'))
  ])))
  .where(WhereOne(QField('users.status'), QO.EQ, QVar('active')))
  .orderBy(QOrder('users.created_at', desc: true))
  .limit(10);
```

### INSERT Operations

```dart
var insertQuery = Q().insert(QField('users'), [
  {
    'name': 'John Doe',
    'email': 'john@example.com',
    'created_at': DateTime.now()
  }
]);

String sql = insertQuery.toSQL();
```

### Database Migrations

```dart
// Initialize migration system
var migration = MysqlMigration(mysqlConnection);

// Run pending migrations
await migration.migrate();

// Rollback last migration
await migration.rollback();

// Create new migration file
await migration.create('add_users_table');
```

### Migration File Example

Create migration files in your `migrations/` directory:

```sql
-- migrations/1234567890_create_users_table.sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ## ROLL BACK:
DROP TABLE users;
```

## Query Builder Reference

### Query Types

- **SELECT**: Use `Q().selects([...]).from(...)`
- **INSERT**: Use `Q().insert(table, data)`
- **UPDATE**: Use `Q().from(...).where(...)`
- **DELETE**: Use `Q().delete().from(...).where(...)`

### Field Types

- `QField('column_name')` - Regular field
- `QSelectAll()` - SELECT *
- `QSelect('field', as: 'alias')` - Field with alias
- `QMath('COUNT(*)')` - Custom SQL expressions

### Operators

- `QO.EQ` - Equals (=)
- `QO.NEQ` - Not equals (!=)
- `QO.GT` - Greater than (>)
- `QO.LT` - Less than (<)
- `QO.GTE` - Greater than or equal (>=)
- `QO.LTE` - Less than or equal (<=)
- `QO.IN` - IN clause
- `QO.NOT_IN` - NOT IN clause
- `QO.LIKE` - LIKE clause
- `QO.NOT_LIKE` - NOT LIKE clause
- `QO.IS_NULL` - IS NULL
- `QO.IS_NOT_NULL` - IS NOT NULL

### Joins

- `Join(table, on)` - INNER JOIN
- `LeftJoin(table, on)` - LEFT JOIN
- `RightJoin(table, on)` - RIGHT JOIN

### Where Conditions

- `WhereOne(field, operator, value)` - Single condition
- `AndWhere([condition1, condition2])` - AND conditions
- `OrWhere([condition1, condition2])` - OR conditions

## Table Management

```dart
// Create table programmatically
var tableBuilder = MySQLTableBuilder('users')
  .addColumn('id', 'INT AUTO_INCREMENT PRIMARY KEY')
  .addColumn('name', 'VARCHAR(255) NOT NULL')
  .addColumn('email', 'VARCHAR(255) UNIQUE NOT NULL')
  .addIndex('email');

await tableBuilder.create(connection);
```

## Best Practices

1. **Use Parameterized Queries**: Always use `QVar()` for user input to prevent SQL injection
2. **Leverage Type Safety**: Use the query builder instead of raw SQL strings
3. **Manage Migrations**: Keep your database schema in version control with migrations
4. **Connection Pooling**: Reuse database connections efficiently
5. **Index Optimization**: Add appropriate indexes for query performance

## Error Handling

```dart
try {
  var result = await connection.execute(query.toSQL());
  // Process result
} on MySQLException catch (e) {
  print('MySQL Error: ${e.message}');
} catch (e) {
  print('General Error: $e');
}
```

This MySQL integration provides a robust foundation for building data-driven web applications with the WebApp package.
